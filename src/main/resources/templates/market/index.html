<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praça do Mercado - RPG Market</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Medieval Sharp -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    
    <!-- CSS files -->
    <link th:href="@{/css/common.css}" rel="stylesheet">
    <link th:href="@{/css/market.css}" rel="stylesheet">
    <link th:href="@{/css/product.css}" rel="stylesheet">
    <link th:href="@{/css/user.css}" rel="stylesheet">
</head>
<body class="rpg-theme">
    <!-- Use direct import for header -->
    <header th:replace="~{layout/main :: header}"></header>
    
    <main class="container py-4 flex-grow-1">
        <!-- Banner de boas-vindas -->
        <div class="welcome-banner p-4 mb-4 text-center rounded border-gold">
            <h1 class="display-5 fw-bold rpg-font">Bem-vindo à Praça do Mercado</h1>
            <p class="lead">Encontre os melhores artefatos mágicos e equipamentos para suas aventuras!</p>
            <div class="mt-3">
                <a th:href="@{/item/novo}" sec:authorize="isAuthenticated()" class="btn btn-gold btn-lg">
                    <i class="fas fa-scroll me-2"></i>Anunciar Item
                </a>
                <a th:href="@{/aventureiro/registrar}" sec:authorize="!isAuthenticated()" class="btn btn-gold btn-lg">
                    <i class="fas fa-user-plus me-2"></i>Registrar-se
                </a>
            </div>
        </div>
        
        <!-- Categorias Principais -->
        <div class="market-section mb-5">
            <h2 class="rpg-font section-title">
                <i class="fas fa-tags me-2"></i>Guildas & Mercadores
            </h2>
            <div class="row g-3">
                <div class="col-6 col-md-3 col-lg-2" th:each="category : ${categories}">
                    <a th:href="@{/mercado/categoria/{category}(category=${category})}" class="text-decoration-none">
                        <div class="card h-100 category-card">
                            <div class="card-body text-center p-3">
                                <div class="category-icon mb-2">
                                    <i class="fas" th:classappend="${
                                        category.name() == 'ARMAS' ? 'fa-sword' : 
                                        (category.name() == 'ARMADURA_VESTIMENTA' ? 'fa-shield-alt' : 
                                        (category.name() == 'POCOES_ELIXIRES' ? 'fa-flask' : 
                                        (category.name() == 'PERGAMINHOS_LIVROS' ? 'fa-book-open' : 
                                        (category.name() == 'JOIAS_ARTEFATOS' ? 'fa-gem' : 
                                        (category.name() == 'MONTARIAS_BESTAS' ? 'fa-horse' : 
                                        (category.name() == 'RELIQUIAS_TECNOLOGICAS' ? 'fa-cog' : 'fa-box'
                                        ))))))
                                    }"></i>
                                </div>
                                <h5 class="card-title mb-0 small" th:text="${category.displayName}">Nome da Categoria</h5>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Itens em Destaque -->
        <div class="market-section mb-5" th:if="${not #lists.isEmpty(products)}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="rpg-font section-title mb-0">
                    <i class="fas fa-scroll me-2"></i>Anúncios Recentes
                </h2>
                <div>
                    <a th:href="@{/item/novo}" sec:authorize="isAuthenticated()" class="btn btn-sm btn-outline-secondary ms-2">
                        <i class="fas fa-plus me-1"></i>Anunciar
                    </a>
                </div>
            </div>
            
            <div class="bulletin-board p-3">
                <div class="row g-4">
                    <div class="col-md-6 col-lg-4" th:each="product : ${products}">
                        <div class="card product-card h-100 market-item">
                            <div class="product-img-container">
                                <img th:if="${product.imageUrl}" th:src="@{/images/{name}(name=${product.imageUrl})}" class="product-img" alt="Imagem do Produto">
                                <img th:unless="${product.imageUrl}" th:src="@{/images/default-product.jpg}" class="product-img" alt="Imagem Padrão">
                                <span class="badge product-category-badge bg-dark" th:text="${product.category.displayName}">Categoria</span>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title rpg-font" th:text="${product.name}">Nome do Item</h5>
                                <p class="card-text flex-grow-1" th:text="${#strings.abbreviate(product.description, 100)}">Descrição truncada do item...</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="product-price" th:text="${'$' + #numbers.formatDecimal(product.price, 0, 'POINT', 2, 'COMMA')}">$99.99</span>
                                    <a th:href="@{/item/{id}(id=${product.id})}" class="btn btn-sm btn-gold">
                                        <i class="fas fa-eye me-1"></i>Ver Detalhes
                                    </a>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>
                                    <span th:text="${product.seller.username}">Vendedor</span>
                                </small>
                                <small class="text-muted float-end" th:text="${#temporals.format(product.createdAt, 'dd/MM/yyyy')}">01/01/2023</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Leilões Ativos -->
        <div class="market-section mb-5" th:if="${not #lists.isEmpty(auctions)}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="rpg-font section-title mb-0">
                    <i class="fas fa-gavel me-2"></i>Leilões da Taverna
                </h2>
                <a th:href="@{/mercado/masmorra-dos-leiloes}" class="btn btn-sm btn-outline-secondary">
                    Ver Todos <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            
            <div class="auction-area p-3">
                <div class="row g-4">
                    <div class="col-md-6 col-lg-4" th:each="auction : ${auctions}">
                        <div class="card product-card h-100 auction-item">
                            <div class="product-img-container">
                                <img th:if="${auction.imageUrl}" th:src="@{/images/{name}(name=${auction.imageUrl})}" class="product-img" alt="Imagem do Produto">
                                <img th:unless="${auction.imageUrl}" th:src="@{/images/default-product.jpg}" class="product-img" alt="Imagem Padrão">
                                <span class="badge product-category-badge bg-dark" th:text="${auction.category.displayName}">Categoria</span>
                                <span class="badge bg-danger position-absolute start-0 top-0 m-2">
                                    <i class="fas fa-gavel me-1"></i>Leilão
                                </span>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title rpg-font" th:text="${auction.name}">Nome do Produto</h5>
                                <p class="card-text text-truncate" th:text="${auction.description}">Descrição do produto...</p>
                                
                                <div class="auction-timer p-2 mb-2">
                                    <i class="fas fa-hourglass-half me-1"></i>
                                    <span>Termina em: <span class="countdown" th:data-end-date="${#temporals.format(auction.auctionEndDate, 'yyyy-MM-dd''T''HH:mm:ss')}">3d 12h 45m</span></span>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="product-price" th:text="${'$' + #numbers.formatDecimal(auction.price, 0, 'POINT', 2, 'COMMA')}">$0.00</span>
                                    <a th:href="@{/item/{id}(id=${auction.id})}" class="btn btn-sm btn-gold">
                                        <i class="fas fa-eye me-1"></i>Detalhes
                                    </a>
                                </div>
                            </div>
                            <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>
                                    <span th:text="${auction.seller.username}">Vendedor</span>
                                </small>
                                <small class="text-muted" th:text="${#temporals.format(auction.createdAt, 'dd/MM/yyyy')}">01/01/2023</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Links rápidos / Quadro de avisos -->
        <div class="market-section">
            <h2 class="rpg-font section-title">
                <i class="fas fa-map-signs me-2"></i>Quadro de Avisos
            </h2>
            <div class="row g-4">
                <div class="col-md-4" sec:authorize="isAuthenticated()">
                    <a th:href="@{/aventureiro/inventario}" class="text-decoration-none">
                        <div class="card h-100 notice-card">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-box-open fa-3x mb-3"></i>
                                <h4 class="rpg-font mb-0">Meu Inventário</h4>
                                <p class="mb-0 mt-2">Gerencie seus itens e vendas!</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-4" sec:authorize="!isAuthenticated()">
                    <a th:href="@{/login}" class="text-decoration-none">
                        <div class="card h-100 notice-card">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-sign-in-alt fa-3x mb-3"></i>
                                <h4 class="rpg-font mb-0">Entrar</h4>
                                <p class="mb-0 mt-2">Faça login para comprar e vender!</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-4">
                    <a th:href="@{/mercado/masmorra-dos-leiloes}" class="text-decoration-none">
                        <div class="card h-100 notice-card">
                            <div class="card-body text-center p-4">
                                <i class="fas fa-gavel fa-3x mb-3"></i>
                                <h4 class="rpg-font mb-0">Leilões</h4>
                                <p class="mb-0 mt-2">Participe de leilões emocionantes!</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Use direct import for footer -->
    <footer th:replace="~{layout/main :: footer}"></footer>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/script.js}"></script>
    
    <script>
        // Atualizar contadores de leilão
        document.addEventListener('DOMContentLoaded', function() {
            const countdowns = document.querySelectorAll('.countdown');
            
            function updateCountdowns() {
                countdowns.forEach(element => {
                    const endDate = new Date(element.getAttribute('data-end-date'));
                    const now = new Date();
                    const diff = endDate - now;
                    
                    if (diff <= 0) {
                        element.textContent = "Encerrado";
                        return;
                    }
                    
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let displayText = "";
                    if(days > 0) displayText += days + "d ";
                    displayText += hours + "h " + minutes + "m";
                    
                    element.textContent = displayText;
                });
            }
            
            // Atualizar imediatamente e depois a cada minuto
            updateCountdowns();
            setInterval(updateCountdowns, 60000);
        });
    </script>
</body>
</html>